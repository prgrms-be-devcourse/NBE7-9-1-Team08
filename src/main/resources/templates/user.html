<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>사용자 페이지 | 수퍼노바 카페</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-KyZXEAg3QhqLMpG8r+8fhAXLRk2vvoC2f3B09zVXn8CA5QIVfZOJ3BCsw2P0p/We" crossorigin="anonymous">

    <style>
        @font-face {
            font-family: 'Pretendard-Regular';
            src: url('https://fastly.jsdelivr.net/gh/Project-Noonnu/noonfonts_2107@1.1/Pretendard-Regular.woff') format('woff');
            font-weight: 400;
            font-style: normal;
        }

        * {
            font-family: Pretendard-Regular;
        }

        body {
            padding: 10%;
            padding-top: 5%;
            background: #f5f5f5;
        }
    </style>
</head>
<body>

<div class="d-flex justify-content-end align-items-center mt-2 me-2" id="top-buttons">
    <a href="/index" class="btn btn-small btn-outline-dark del-button"
       style="text-decoration: none; width: auto; height: auto; white-space: nowrap; margin-right: 10px">
        주문 페이지로 돌아가기
    </a>
</div>

<br><br>
<h3>고객님의 주문목록</h3>
<hr>
<br>
<div>
    <table class="table">
        <thead>
        <tr>
            <th style="text-align: center">번호</th>
            <th style="text-align: center">주문 번호</th>
            <th style="text-align: center">이메일</th>
            <th style="text-align: center">주소</th>
            <th style="text-align: center">상품명</th>
            <th style="text-align: center">수량</th>
            <th style="text-align: center">총 가격</th>
            <th style="text-align: center">주문 상태</th>
        </tr>
        </thead>
        <tbody id="orderTable">
        </tbody>
    </table>
</div>

<script>
    // 로그인 시 저장된 이메일 가져오기
    const userEmail = sessionStorage.getItem("userEmail");

    if (!userEmail) {
        alert("로그인이 필요합니다.");
        window.location.href = "/user_login";
    } else {
        fetch(`http://localhost:8080/api/members/${userEmail}/orders`)
            .then(resp => resp.json())
            .then(response => {
                const orders = response.data;
                const tbody = document.getElementById("orderTable");
                tbody.innerHTML = '';

                if (!orders || orders.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="8" style="text-align: center; color: gray;">
                                주문 내역이 없습니다.
                            </td>
                        </tr>
                    `;
                    return;
                }

                orders.forEach((order, index) => {
                    const productNames = order.items
                        .map(item => item.productName)
                        .join('<br>');

                    const quantities = order.items
                        .map(item => `${item.quantity}개`)
                        .join('<br>');

                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td style="text-align: center">${index + 1}</td>
                        <td style="text-align: center">${order.orderId}</td>
                        <td style="text-align: center">${order.email}</td>
                        <td style="text-align: center">${order.address} (${order.postalCode})</td>
                        <td style="text-align: center">${productNames}</td>
                        <td style="text-align: center">${quantities}</td>
                        <td style="text-align: center">${order.totalPrice}원</td>
                        <td style="text-align: center; font-weight: bold; color: ${order.orderState === 'COMPLETED' ? 'green' : 'red'};">
                            ${order.orderState === 'COMPLETED' ? '배달 완료' : '배달 준비중'}
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            })
            .catch(err => {
                console.error("주문 내역 조회 실패:", err);
            });
    }
</script>
</body>
</html>
